name: Security Analysis - PHP

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      # 🔹 Étape 1 : Checkout du code source
      - name: 🟦 Checkout code
        uses: actions/checkout@v3

      # 🔹 Étape 2 : Cache des dépendances Composer
      - name: 📁 Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      # 🔹 Étape 3 : Installation des dépendances Composer
      - name: 📦 Install Composer dependencies
        run: composer install --no-progress --no-interaction

      # 🔹 Étape 4 : Analyse Trivy sur les dépendances PHP
      - name: 🔍 Run Trivy (PHP dependencies)
        uses: aquasecurity/trivy-action@v0.12.0
        with:
          scan-type: filesystem
          exit-code: 0
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          output: trivy-report.txt
        continue-on-error: true

      # 🔹 Étape 5 : Installation de OWASP ZAP
      - name: 🟧 Setup OWASP ZAP
        run: |
          sudo apt-get update && sudo apt-get install -y wget
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.13.0/ZAP_2.13.0_Linux.tar.gz
          tar -xzf ZAP_2.13.0_Linux.tar.gz
          sudo mv ZAP_2.13.0 /opt/zap

      # 🔹 Étape 6 : Scan OWASP ZAP en mode "baseline"
      - name: ⚡ OWASP ZAP Baseline Scan (Simulé)
        run: |
          /opt/zap/zap.sh -daemon -port 8080 -config api.disablekey=true &
          sleep 10  # Temps pour démarrer ZAP
          # Scan simulé sur une URL d'exemple
          /opt/zap/zap.sh -cmd -quickurl http://example.com -quickout zap-report.html -quickprogress
        continue-on-error: true

      # 🔹 Étape 7 : Upload des rapports en tant qu'artefacts
      - name: 📄 Upload Reports
        uses: actions/upload-artifact@v3
        with:
          name: Security Reports
          path: |
            trivy-report.txt
            zap-report.html

